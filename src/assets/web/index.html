<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ðŸ’™COLLECTIVE</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="coi-serviceworker.js"></script>

    <script>
        // see https://stackoverflow.com/questions/67089372/await-async-execution-in-sync-function-in-webworker-javascript and https://stackoverflow.com/questions/10590213/synchronously-wait-for-message-in-web-worker
        let rustWorker = new Worker('rust-worker.js', { type: "module" });

        rustWorker.addEventListener("message", async (event) => {
            console.log("event", event);
            message = event.data;
            if (message.type === "call") {
                let args = JSON.parse(message.args);
                console.log("Args from Rust: ", message);
                let result = await window[message.method](...args);
                Atomics.notify(new Int32Array(message.sab), 0);
            }
        });
        /*        rustWorker.onmessage = async function(event) { 
                    let message = event.data;
                    console.log("Message from Rust: ", message);
                    if (message.type === "call") {
                        let allowedMethods = ["print_js", "get_base_url", "get_url"];
                        if (allowedMethods.includes(message.method)) {
                            let args = JSON.parse(message.args);
                            console.log("Args from Rust: ", event);
                            let result = await window[message.method](...args);
                            console.log("Result from JS: ", result);
                            Atomics.notify(new Int32Array(message.sab), 0);
                            console.log("Notified Rust: ", message.sab);
                            rustWorker.postMessage({ type: "result", result: result, index: message.index, sab: message.response_sab });
                            console.log("Posted message: ", message.response_sab);
                        } else {
                            console.error("Method not allowed: " + message.method);
                        }
                    } else if (message.type === "log") {
                        console.log(message);
                    }
                }*/
        window.print_js = function (string) {
            document.getElementById("textFrame").textContent = string;
        };
        window.get_base_url = function (string) {
            let url = window.location.href;
            let base_url = url.substring(0, url.lastIndexOf('/'));
            return base_url;
        };
        window.get_url = async function (url) {
            let response = await fetch(url);
            return await response.text();
            //             console.log("Response from URL: ", { type: "result", result: await response.text(), index: index });
            let result = { type: "result", result: await response.text(), index: index };
            console.log("Result from URL: ", result);
            rustWorker.postMessage(result);
            console.log("Message sent to Rust: ", result);
            return;
            rustWorker.postMessage({ type: "result", result: await response.text(), index: index });
        };
    </script>

    <link rel="stylesheet" href="./app.css">
</head>

<body class="w-full h-full p-4 bg-rose-50">
    <div class="flex flex-col w-full gap-y-4">
        <pre id="textFrame" class="font-mono w-full grow card"></pre>
        <pre id="textLog" class="font-mono w-full h-1/5 card"></pre>
    </div>
</body>

</html>